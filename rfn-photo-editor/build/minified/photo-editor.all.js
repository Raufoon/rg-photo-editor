function ringImageTextInserter(t,e,i){function n(){y=document.getElementById(e),(x=document.getElementById(i)).style.display="block",x.width=y.width,x.height=y.height,v=x.getBoundingClientRect(),w=x.getContext("2d"),D=!1,(b=angular.element(x)).on("mouseup",c),b.on("mousedown",u),b.on("mousemove",l),b.on("mouseout",m)}function r(){x.style.display="none",b.off("mouseup",c),b.off("mousedown",u),b.off("mousemove",l),b.off("mouseout",m)}function s(t,e,i,n){R.noText=!1,R.textHistory.push({text:t,font:e,color:i,size:n,x:y.width/3,y:y.height/3,textWidth:w.measureText(t).width}),a()}function o(){w.clearRect(0,0,y.width,y.height)}function a(){var t,e;for(o(),t=0;t<R.textHistory.length;t++)e=R.textHistory[t],w.font=e.size+"px "+e.font,w.fillStyle=e.color,w.fillText(e.text,e.x,e.y),w.strokeRect(e.x,e.y-e.size,w.measureText(e.text).width,e.size)}function h(){o(),R.textHistory=[],R.noText=!0}function c(){D=!1,C=void 0}function u(t){var e,i;D=!0,R.noText||(e=p(t),i=f(t),(C=g(e,i))&&l(t))}function l(t){var e,i;D&&!R.noText&&C&&(e=p(t),i=f(t),C.x=e,C.y=i,a())}function g(t,e){var i;for(i=0;i<R.textHistory.length;i++)if(d(R.textHistory[i],t,e))return R.textHistory[i]}function d(t,e,i){var n=t.x,r=t.y-t.size,s=t.x+t.textWidth,o=t.y;return e>=n&&e<=s&&i>=r&&i<=o}function p(t){var e=b[0].getBoundingClientRect();return Math.round((t.clientX-e.left)/(e.right-e.left)*b[0].width)}function f(t){var e=b[0].getBoundingClientRect();return Math.round((t.clientY-e.top)/(e.bottom-e.top)*b[0].height)}function m(){D=!1,C=void 0}var y,x,b,v,w,D,C,R=t;this.initTextOptions=n,this.exit=r,this.addtext=s,this.clearAllText=h,R.textHistory=[]}function ringImageCropper(t,e,i){function n(){var t;(f=angular.element(document.getElementById(i))).on("mouseup",g),f.on("mousedown",l),f.on("mousemove",d),o(),(t=f[0].getContext("2d")).strokeStyle="#ffcb85",t.lineWidth=5,a(),r(!1)}function r(t){D.crSel=t}function s(){m=!1,a(),f.off("mouseup",g),f.off("mousedown",l),f.off("mousemove",d),f[0].style.display="none",r(!1)}function o(){var t=angular.element(document.getElementById(e))[0];(f=angular.element(document.getElementById(i)))[0].style.display="block",f[0].height=t.height,f[0].width=t.width,y=f[0].getBoundingClientRect()}function a(){var t=f[0].getContext("2d");t.fillStyle="rgba(0, 0, 0, 0.7)",t.clearRect(0,0,f[0].width,f[0].height),t.fillRect(0,0,f[0].width,f[0].height)}function h(t,e,i,n){var r=Math.min(t,i),s=Math.min(e,n),o=Math.abs(t-i),a=Math.abs(e-n),h=f[0].getContext("2d");h.strokeRect(r,s,o,a),h.clearRect(r,s,o,a)}function c(t){return Math.round((t.clientX-y.left)/(y.right-y.left)*f[0].width)}function u(t){return Math.round((t.clientY-y.top)/(y.bottom-y.top)*f[0].height)}function l(t){m||(r(!1),m=!0,o(),a(),x=v=c(t),b=w=u(t))}function g(){m=!1,Math.abs(x-v)<20&&Math.abs(b-w)<20?(r(!1),a()):r(!0),D.$digest()}function d(t){m&&(v=c(t),w=u(t),a(),h(x,b,v,w))}function p(){var t=Math.min(x,v),e=Math.min(b,w);return{cropWidth:Math.abs(x-v),cropHeight:Math.abs(b-w),cropX0:t,cropY0:e}}var f,m,y,x,b,v,w,D=t;this.initCropSection=n,this.exitCropSection=s,this.initOffSrcCanvas=o,this.clearOffSrcCanvas=a,this.setCropSelected=r,this.getCropParam=p}function ringPhotoEditorController(t,e){function i(e){t.isPortrait=e,n(e),r(),s(),o(),a(),h(),c(),t.$digest()}function n(e){t.W=.8*window.screen.width,t.H=.8*window.screen.height,t.mdW=e?"35%":"20%",t.rdW=e?"58%":"73%",t.filtW=e?"48%":"98%",t.$digest()}function r(){P(!0),document.getElementById(A).src=t.imageSrc,F=window.Caman("#"+A),P(!1)}function s(){function e(t,e,i){this.minValue=void 0===t?-100:t,this.maxValue=void 0===e?100:e,this.value=i||0,this.default=i||0}t.optionList=["brightness","contrast","saturation","sharpen","exposure","noise","vibrance","sepia","hue","gamma","stackBlur","clip"],t.optionValues={brightness:new e,contrast:new e,saturation:new e,sharpen:new e(0),exposure:new e,vibrance:new e,hue:new e(0),gamma:new e(0,10),clip:new e(0),stackBlur:new e(0,20),noise:new e(0),sepia:new e(0)}}function o(){t.filterList=["vintage","jarques","pinhole","oldBoot","glowingSun","hazyDays","herMajesty","nostalgia","lomo","emboss","clarity","sinCity","sunrise","crossProcess","orangePeel","love","grungy","hemingway","concentrate","greyscale","invert"]}function a(){L=new ringImageCropper(t,A,O,F),t.cropCancel=L.onCropCancel,t.crop=u,t.cropCancel=l}function h(){var e;for(t.fontSizes=[],e=10;e<101;e++)t.fontSizes.push(e);t.fonts=["Arial","Helvetica","Times New Roman","Courier New","Verdana","Georgia","Palatino","Garamond","Comic Sans MS","Impact"],k=new ringImageTextInserter(t,A,"text-canvas"),t.addtext=function(){k.addtext(document.getElementById("id-text-to-add").value,document.getElementById("id-font").value,document.getElementById("id-font-color").value,document.getElementById("id-font-size").value)},t.noText=!0}function c(){var t;(t=document.getElementById("id-photo-editor-outer").style).visibility="visible",t.height=parseInt(.8*window.screen.height)+"px",t.width=parseInt(.8*window.screen.width)+"px"}function u(){var e=L.getCropParam(),i=document.getElementById(A),n=document.getElementById(O),r=e.cropWidth,s=e.cropHeight,o=e.cropX0,a=e.cropY0;z||(P(!0),n.style.visibility="hidden",i.style.visibility="hidden",F.crop(r,s,o,a).render(function(){d(),t.isCropped=!0}),L.setCropSelected(!1))}function l(){L.setCropSelected(!1),L.clearOffSrcCanvas()}function g(){P(!0),t.isCropped=!1,F.reset(),d()}function d(e){var i;e&&(E[e]=parseInt(t.optionValues[e].value,10)),F.revert(!1),t.hasFilter&&F[t.lastAppliedFilter]();for(i in E)F[i](E[i]);F.render(function(){"crop"===t.curOptTab&&(L.initOffSrcCanvas(),L.clearOffSrcCanvas(),document.getElementById(O).style.visibility="visible"),document.getElementById(A).style.visibility="visible",P(!1)}),e&&E[e]===t.optionValues[e].default&&delete E[e]}function p(t){z||(P(!0),d(t))}function f(e){z||(P(!0),t.hasFilter=!0,t.lastAppliedFilter=e,d())}function m(){z||(P(!0),t.hasFilter=!1,t.lastAppliedFilter="",d())}function y(){var t=document.getElementById("photo-edit-canvas-id");z||(P(!0),t.style.visibility="hidden",F.rotate(90),F.render(function(){d()}))}function x(){var e,i;for(e=0;e<t.optionList.length;e++)i=t.optionList[e],t.optionValues[i].value=t.optionValues[i].default}function b(){z||(P(!0),S(),x(),F.reset(),F.render(function(){"crop"===t.curOptTab&&(L.initOffSrcCanvas(),L.clearOffSrcCanvas()),P(!1)}))}function v(){var e,i,n=document.getElementById(A),r=n.getContext("2d");if(!z){for(P(!0),e=0;e<t.textHistory.length;e++)i=t.textHistory[e],r.font=i.size+"px "+i.font,r.fillStyle=i.color,r.fillText(i.text,i.x,i.y);t.noText=!0,w(),F.replaceCanvas(D(n)),t.isCropped=!1,t.hasFilter=!1,t.lastAppliedFilter="",x(),P(!1)}}function w(){k.clearAllText()}function D(t){var e=document.createElement("canvas"),i=e.getContext("2d");return e.width=t.width,e.height=t.height,i.drawImage(t,0,0),e}function C(t){var e,i,n=t.charAt(0).toUpperCase();for(e=1;e<t.length;e++)(i=t.charAt(e)).toUpperCase()===i?n+=" "+i:n+=i;return n}function R(e,i,n,r,s){return t.curOptTab===e?n||"white":i?r||"#ecf0f7":s||"#f0f1f3"}function M(e,i,n,r,s){return t.lastAppliedFilter===e?n||"white":i?r||"#3399ff":s||"#0089b7"}function S(){t.lastAppliedFilter="",t.crSel=!1,t.isCropped=!1,t.hasFilter=!1,E=Object.create(null)}function I(e){z||("crop"===t.curOptTab&&"crop"!==e?L.exitCropSection():"text"===t.curOptTab&&"text"!==e&&k.exit(),t.curOptTab=e,"crop"===e?L.initCropSection():"text"===e&&k.initTextOptions())}function P(t){var e,i,n,r=document.getElementById("loader-canvas");(z=t)?(e=document.getElementById(A),r.style.display="block",r.width=e.width,r.height=e.height,(n=r.getContext("2d")).font="60px Arial",n.fillStyle="#f47727",i=n.measureText("Loading...").width/2,n.fillText("Loading...",r.width/2-i,r.height/2)):r.style.display="none"}function B(){t.saveFunction(document.getElementById("photo-edit-canvas-id")),e.close()}var F,L,k,T=new Image,z=!1,A="photo-edit-canvas-id",O="offscr-canvas",E=Object.create(null);t.imageSrc="https://"+t.imageUrl,t.optionList=[],t.optionValues={},t.curOptTab="filters",S(),t.title=C,t.adjust=p,t.onFilterApply=f,t.removeFilter=m,t.undoCrop=g,t.reset=b,t.setOptTab=I,t.save=B,t.lastAppliedFilter="",t.btncol=R,t.filtBtnCol=M,t.rotate=y,t.applyText=v,t.clearText=w,t.closeRingbox=e.close,angular.element(document).ready(function(){T.src=t.imageSrc,T.onload=function(){i(this.height>this.width)}})}(function(){var t,e,i,n,r,s,o,a,h,c,u,l,g,d,p,f,m,y,x,b,v,w,D,C,R,M,S=[].indexOf||function(t){for(var e=0,i=this.length;e<i;e++)if(e in this&&this[e]===t)return e;return-1},I=[].slice,P={}.hasOwnProperty,B=function(t,e){return function(){return t.apply(e,arguments)}},F=function(t,e){function i(){this.constructor=t}for(var n in e)P.call(e,n)&&(t[n]=e[n]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};R=["extended","included"],f=function(){function t(){}return t.extends=function(t){var e,i,n;for(e in t)i=t[e],S.call(R,e)<0&&(this[e]=i);return null!=(n=t.extended)&&n.apply(this),this},t.includes=function(t){var e,i,n;for(e in t)i=t[e],S.call(R,e)<0&&(this.prototype[e]=i);return null!=(n=t.included)&&n.apply(this),this},t.delegate=function(){var t,e,i,n,r,s;for(i=(t=1<=arguments.length?I.call(arguments,0):[]).pop(),s=[],n=0,r=t.length;n<r;n++)e=t[n],s.push(this.prototype[e]=i.prototype[e]);return s},t.aliasFunction=function(t,e){return this.prototype[t]=function(t){return function(){var i;return i=1<=arguments.length?I.call(arguments,0):[],t.prototype[e].apply(t,i)}}(this)},t.aliasProperty=function(t,e){return Object.defineProperty(this.prototype,t,{get:function(){return this[e]},set:function(t){return this[e]=t}})},t.included=function(t){return t.call(this,this.prototype)},t}(),Array.prototype.slice,t=function(t,e){return null==e&&(e=document),"object"==typeof t||"undefined"!=typeof exports&&null!==exports?t:e.querySelector(t)},w=function(){function t(){}return t.uniqid=function(){var t;return t=0,{get:function(){return t++}}}(),t.extend=function(){var t,e,i,n,r,s;for(e=arguments[0],r=0,s=(n=2<=arguments.length?I.call(arguments,1):[]).length;r<s;r++){t=n[r];for(i in t)P.call(t,i)&&(e[i]=t[i])}return e},t.clampRGB=function(t){return t<0?0:t>255?255:t},t.copyAttributes=function(t,e,i){var n,r,s,o,a,h;for(null==i&&(i={}),h=[],r=0,s=(o=t.attributes).length;r<s;r++)n=o[r],null!=i.except&&(a=n.nodeName,S.call(i.except,a)>=0)||h.push(e.setAttribute(n.nodeName,n.nodeValue));return h},t.dataArray=function(t){return null==t&&(t=0),r.NodeJS||null!=window.Uint8Array?new Uint8Array(t):new Array(t)},t}(),"undefined"!=typeof exports&&null!==exports?(b=exports,o=require("canvas"),g=o.Image,c=require("fibers"),D=require("fs"),C=require("http")):b=window,r=function(i){function n(){this.nodeFileReady=B(this.nodeFileReady,this);var t,i,r;if(0===arguments.length)throw"Invalid arguments";return this instanceof n?(this.finishInit=this.finishInit.bind(this),this.imageLoaded=this.imageLoaded.bind(this),t=arguments[0],n.NodeJS||(r=parseInt(n.getAttrId(t[0]),10),i="function"==typeof t[1]?t[1]:"function"==typeof t[2]?t[2]:function(){},isNaN(r)||!v.has(r))?(this.id=w.uniqid.get(),this.initializedPixelData=this.originalPixelData=null,this.cropCoordinates={x:0,y:0},this.cropped=!1,this.resized=!1,this.rotated=!1,this.rotationAngle=0,this.pixelStack=[],this.layerStack=[],this.canvasQueue=[],this.currentLayer=null,this.scaled=!1,this.analyze=new e(this),this.renderer=new x(this),this.domIsLoaded(function(e){return function(){return e.parseArguments(t),e.setup()}}(this)),this):v.execute(r,i)):new n(arguments)}return F(n,i),n.version={release:"4.1.2",date:"7/27/2013"},n.DEBUG=!1,n.allowRevert=!0,n.crossOrigin="anonymous",n.remoteProxy="",n.proxyParam="camanProxyUrl",n.NodeJS="undefined"!=typeof exports&&null!==exports,n.autoload=!n.NodeJS,n.toString=function(){return"Version "+n.version.release+", Released "+n.version.date},n.getAttrId=function(e){return!!n.NodeJS||("string"==typeof e&&(e=t(e)),null==e||null==e.getAttribute?null:e.getAttribute("data-caman-id"))},n.prototype.domIsLoaded=function(t){var e;return n.NodeJS?setTimeout(function(e){return function(){return t.call(e)}}(this),0):"complete"===document.readyState?(p.debug("DOM initialized"),setTimeout(function(e){return function(){return t.call(e)}}(this),0)):(e=function(e){return function(){if("complete"===document.readyState)return p.debug("DOM initialized"),t.call(e)}}(this),document.addEventListener("readystatechange",e,!1))},n.prototype.parseArguments=function(t){var e,i,n,r;if(0===t.length)throw"Invalid arguments given";if(this.initObj=null,this.initType=null,this.imageUrl=null,this.callback=function(){},this.setInitObject(t[0]),1!==t.length){switch(typeof t[1]){case"string":this.imageUrl=t[1];break;case"function":this.callback=t[1]}if(2!==t.length&&(this.callback=t[2],4===t.length)){n=t[4],r=[];for(e in n)P.call(n,e)&&(i=n[e],r.push(this.options[e]=i));return r}}},n.prototype.setInitObject=function(e){if(n.NodeJS)return this.initObj=e,void(this.initType="node");if(this.initObj="object"==typeof e?e:t(e),null==this.initObj)throw"Could not find image or canvas for initialization.";return this.initType=this.initObj.nodeName.toLowerCase()},n.prototype.setup=function(){switch(this.initType){case"node":return this.initNode();case"img":return this.initImage();case"canvas":return this.initCanvas()}},n.prototype.initNode=function(){return p.debug("Initializing for NodeJS"),"string"==typeof this.initObj&&this.initObj.match(/^https?:\/\//)?this.readFromHttp(this.initObj,this.nodeFileReady):"string"==typeof this.initObj?D.readFile(this.initObj,this.nodeFileReady):this.nodeFileReady(null,this.initObj)},n.prototype.readFromHttp=function(t,e){return p.debug("Fetching image from "+t),C.get(t,function(t){var i;return i="",t.setEncoding("binary"),t.on("data",function(t){return i+=t}),t.on("end",function(){return e(null,new Buffer(i,"binary"))})}).on("error",e)},n.prototype.nodeFileReady=function(t,e){if(t)throw t;return this.image=new g,this.image.src=e,p.debug("Image loaded. Width = "+this.imageWidth()+", Height = "+this.imageHeight()),this.canvas=new o(this.imageWidth(),this.imageHeight()),this.renderingCanvas=new o(this.imageWidth(),this.imageHeight()),this.finishInit()},n.prototype.initImage=function(){return this.image=this.initObj,this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.renderingCanvas=document.createElement("canvas"),this.renderingContext=this.renderingCanvas.getContext("2d"),w.copyAttributes(this.image,this.canvas,{except:["src"]}),w.copyAttributes(this.image,this.renderingCanvas,{except:["src"]}),null!=this.image.parentNode&&this.image.parentNode.replaceChild(this.renderingCanvas,this.image),this.imageAdjustments(),this.waitForImageLoaded()},n.prototype.initCanvas=function(){return this.canvas=this.initObj,this.context=this.canvas.getContext("2d"),this.renderingCanvas=document.createElement("canvas"),this.renderingContext=this.renderingCanvas.getContext("2d"),null!=this.imageUrl?(this.image=document.createElement("img"),this.image.src=this.imageUrl,this.imageAdjustments(),this.waitForImageLoaded()):this.finishInit()},n.prototype.imageAdjustments=function(){if(this.needsHiDPISwap()&&(p.debug(this.image.src,"->",this.hiDPIReplacement()),this.swapped=!0,this.image.src=this.hiDPIReplacement()),l.isRemote(this.image))return this.image.src=l.proxyUrl(this.image.src),p.debug("Remote image detected, using URL = "+this.image.src)},n.prototype.waitForImageLoaded=function(){return this.isImageLoaded()?this.imageLoaded():this.image.onload=this.imageLoaded},n.prototype.isImageLoaded=function(){return!!this.image.complete&&(null==this.image.naturalWidth||0!==this.image.naturalWidth)},n.prototype.imageWidth=function(){return this.image.width||this.image.naturalWidth},n.prototype.imageHeight=function(){return this.image.height||this.image.naturalHeight},n.prototype.imageLoaded=function(){return p.debug("Image loaded. Width = "+this.imageWidth()+", Height = "+this.imageHeight()),this.swapped?(this.canvas.width=this.imageWidth()/this.hiDPIRatio(),this.canvas.height=this.imageHeight()/this.hiDPIRatio(),this.renderingCanvas.width=this.imageWidth()/this.hiDPIRatio(),this.renderingCanvas.height=this.imageHeight()/this.hiDPIRatio()):(this.canvas.width=this.imageWidth(),this.canvas.height=this.imageHeight(),this.renderingCanvas.width=this.imageWidth(),this.renderingCanvas.height=this.imageHeight()),this.finishInit()},n.prototype.finishInit=function(){var t,e,i,r,s;if(null==this.context&&(this.context=this.canvas.getContext("2d")),null==this.renderingContext&&(this.renderingContext=this.renderingCanvas.getContext("2d")),this.originalWidth=this.preScaledWidth=this.width=this.canvas.width,this.originalHeight=this.preScaledHeight=this.height=this.canvas.height,this.hiDPIAdjustments(),this.hasId()||this.assignId(),null!=this.image&&(this.context.drawImage(this.image,0,0,this.imageWidth(),this.imageHeight(),0,0,this.preScaledWidth,this.preScaledHeight),this.renderingContext.drawImage(this.image,0,0,this.imageWidth(),this.imageHeight(),0,0,this.preScaledWidth,this.preScaledHeight)),this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),this.pixelData=this.imageData.data,n.allowRevert)for(this.initializedPixelData=w.dataArray(this.pixelData.length),this.originalPixelData=w.dataArray(this.pixelData.length),t=i=0,r=(s=this.pixelData).length;i<r;t=++i)e=s[t],this.initializedPixelData[t]=e,this.originalPixelData[t]=e;return this.dimensions={width:this.canvas.width,height:this.canvas.height},n.NodeJS||v.put(this.id,this),this.callback.call(this,this),this.callback=function(){}},n.prototype.reloadCanvasData=function(){return this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),this.pixelData=this.imageData.data},n.prototype.resetOriginalPixelData=function(){var t,e,i,r,s,o;if(!n.allowRevert)throw"Revert disabled";for(this.originalPixelData=w.dataArray(this.pixelData.length),o=[],t=i=0,r=(s=this.pixelData).length;i<r;t=++i)e=s[t],o.push(this.originalPixelData[t]=e);return o},n.prototype.hasId=function(){return null!=n.getAttrId(this.canvas)},n.prototype.assignId=function(){if(!n.NodeJS&&!this.canvas.getAttribute("data-caman-id"))return this.canvas.setAttribute("data-caman-id",this.id)},n.prototype.hiDPIDisabled=function(){return null!==this.canvas.getAttribute("data-caman-hidpi-disabled")},n.prototype.hiDPIAdjustments=function(){var t;if(!n.NodeJS&&this.needsHiDPISwap())return t=this.hiDPIRatio(),1!==t?(p.debug("HiDPI ratio = "+t),this.scaled=!0,this.preScaledWidth=this.canvas.width,this.preScaledHeight=this.canvas.height,this.canvas.width=this.preScaledWidth*t,this.canvas.height=this.preScaledHeight*t,this.canvas.style.width=this.preScaledWidth+"px",this.canvas.style.height=this.preScaledHeight+"px",this.context.scale(t,t),this.width=this.originalWidth=this.canvas.width,this.height=this.originalHeight=this.canvas.height):void 0},n.prototype.hiDPIRatio=function(){var t,e;return e=window.devicePixelRatio||1,t=this.context.webkitBackingStorePixelRatio||this.context.mozBackingStorePixelRatio||this.context.msBackingStorePixelRatio||this.context.oBackingStorePixelRatio||this.context.backingStorePixelRatio||1,e/t},n.prototype.hiDPICapable=function(){return null!=window.devicePixelRatio&&1!==window.devicePixelRatio},n.prototype.needsHiDPISwap=function(){return!(this.hiDPIDisabled()||!this.hiDPICapable())&&null!==this.hiDPIReplacement()},n.prototype.hiDPIReplacement=function(){return null==this.image?null:this.image.getAttribute("data-caman-hidpi")},n.prototype.replaceCanvas=function(t){var e,i,r,s,o;if(this.canvas=t,this.context=this.canvas.getContext("2d"),this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),this.pixelData=this.imageData.data,n.allowRevert)for(this.originalPixelData=w.dataArray(this.pixelData.length),e=r=0,s=(o=this.pixelData).length;r<s;e=++r)i=o[e],this.originalPixelData[e]=i;return this.width=this.canvas.width,this.height=this.canvas.height,this.reloadCanvasData(),this.dimensions={width:this.canvas.width,height:this.canvas.height}},n.prototype.render=function(t){return null==t&&(t=function(){}),h.trigger(this,"renderStart"),this.renderer.execute(function(e){return function(){return e.renderingCanvas.width=e.canvas.width,e.renderingCanvas.height=e.canvas.height,e.renderingContext.putImageData(e.imageData,0,0),t.call(e)}}(this))},n.prototype.revert=function(t){var e,i,r,s,o;if(null==t&&(t=!0),!n.allowRevert)throw"Revert disabled";for(e=r=0,s=(o=this.originalVisiblePixels()).length;r<s;e=++r)i=o[e],this.pixelData[e]=i;if(t)return this.renderingContext.putImageData(this.imageData,0,0)},n.prototype.reset=function(){var t,e,i,n,r,s,o,a,h;for(t=document.createElement("canvas"),w.copyAttributes(this.canvas,t),t.width=this.originalWidth,t.height=this.originalHeight,s=(n=(e=t.getContext("2d")).getImageData(0,0,t.width,t.height)).data,i=o=0,a=(h=this.initializedPixelData).length;o<a;i=++o)r=h[i],s[i]=r;return e.putImageData(n,0,0),this.cropCoordinates={x:0,y:0},this.resized=!1,this.replaceCanvas(t)},n.prototype.originalVisiblePixels=function(){var t,e,i,r,s,o,a,h,c,u,l;if(!n.allowRevert)throw"Revert disabled";for(o=[],0,e=0+this.width,0,i=0+this.height,s=this.originalPixelData,a=this.canvas.width,r=h=0,c=s.length;h<c;r=h+=4)0<=(u=(t=m.locationToCoordinates(r,a)).x)&&u<e&&0<=(l=t.y)&&l<i&&o.push(s[r],s[r+1],s[r+2],s[r+3]);return o},n.prototype.process=function(t,e){return this.renderer.add({type:u.Type.Single,name:t,processFn:e}),this},n.prototype.processKernel=function(t,e,i,n){var r,s,o;if(null==i&&(i=null),null==n&&(n=0),null==i)for(i=0,r=s=0,o=e.length;0<=o?s<o:s>o;r=0<=o?++s:--s)i+=e[r];return this.renderer.add({type:u.Type.Kernel,name:t,adjust:e,divisor:i,bias:n}),this},n.prototype.processPlugin=function(t,e){return this.renderer.add({type:u.Type.Plugin,plugin:t,args:e}),this},n.prototype.newLayer=function(t){var e;return e=new d(this),this.canvasQueue.push(e),this.renderer.add({type:u.Type.LayerDequeue}),t.call(e),this.renderer.add({type:u.Type.LayerFinished}),this},n.prototype.executeLayer=function(t){return this.pushContext(t)},n.prototype.pushContext=function(t){return this.layerStack.push(this.currentLayer),this.pixelStack.push(this.pixelData),this.currentLayer=t,this.pixelData=t.pixelData},n.prototype.popContext=function(){return this.pixelData=this.pixelStack.pop(),this.currentLayer=this.layerStack.pop()},n.prototype.applyCurrentLayer=function(){return this.currentLayer.applyToParent()},n}(f),b.Caman=r,r.Analyze=function(){function t(t){this.c=t}return t.prototype.calculateLevels=function(){var t,e,i,n,r,s,o;for(e={r:{},g:{},b:{}},t=n=0;n<=255;t=++n)e.r[t]=0,e.g[t]=0,e.b[t]=0;for(t=r=0,o=this.c.pixelData.length;r<o;t=r+=4)e.r[this.c.pixelData[t]]++,e.g[this.c.pixelData[t+1]]++,e.b[this.c.pixelData[t+2]]++;for(i=this.c.pixelData.length/4,t=s=0;s<=255;t=++s)e.r[t]/=i,e.g[t]/=i,e.b[t]/=i;return e},t}(),e=r.Analyze,r.DOMUpdated=function(){var t,e,i,n,r;if((e=document.querySelectorAll("img[data-caman]")).length>0){for(r=[],i=0,n=e.length;i<n;i++)t=e[i],r.push(new s(t,function(){return this.parse(),this.execute()}));return r}},r.autoload&&function(){"complete"===document.readyState?r.DOMUpdated():document.addEventListener("DOMContentLoaded",r.DOMUpdated,!1)}(),s=function(){function t(t,e){this.dataStr=t.getAttribute("data-caman"),this.caman=r(t,e.bind(this))}return"(\\w+)\\((.*?)\\)",t.prototype.parse=function(){var t,e,i,n,r,s,o,a,h,c,u;if(this.ele=this.caman.canvas,s=new RegExp("(\\w+)\\((.*?)\\)","g"),(o=this.dataStr.match(s)).length>0){for(s=new RegExp("(\\w+)\\((.*?)\\)"),u=[],a=0,h=o.length;a<h;a++){(c=o[a].match(s))[0],i=c[1],t=c[2],r=new Function("return function() { this."+i+"("+t+"); };");try{n=r(),u.push(n.call(this.caman))}catch(t){e=t,u.push(p.debug(e))}}return u}},t.prototype.execute=function(){var t;return t=this.ele,this.caman.render(function(){return t.parentNode.replaceChild(this.toImage(),t)})},t}(),r.Blender=function(){function t(){}return t.blenders={},t.register=function(t,e){return this.blenders[t]=e},t.execute=function(t,e,i){return this.blenders[t](e,i)},t}(),i=r.Blender,r.Calculate=function(){function t(){}return t.distance=function(t,e,i,n){return Math.sqrt(Math.pow(i-t,2)+Math.pow(n-e,2))},t.randomRange=function(t,e,i){var n;return null==i&&(i=!1),n=t+Math.random()*(e-t),i?n.toFixed(i):Math.round(n)},t.luminance=function(t){return.299*t.r+.587*t.g+.114*t.b},t.bezier=function(t,e,i,n,s,o){var a,h,c,u,l,g,d,p,f,m,y,x,b;if(null==s&&(s=0),null==o&&(o=255),t[0]instanceof Array?(c=t,s=e,o=i):c=[t,e,i,n],c.length<2)throw"Invalid number of arguments to bezier";for(a={},d=function(t,e,i){return t*(1-i)+e*i},h=function(t,e,i){return Math.min(Math.max(t,e),i)},l=y=0;y<1e3;l=++y){for(m=l/1e3,f=c;f.length>1;){for(p=[],g=x=0,b=f.length-2;0<=b?x<=b:x>=b;g=0<=b?++x:--x)p.push([d(f[g][0],f[g+1][0],m),d(f[g][1],f[g+1][1],m)]);f=p}a[Math.round(f[0][0])]=Math.round(h(f[0][1],s,o))}return u=c[c.length-1][0],null==(a=r.Calculate.missingValues(a,u))[u]&&(a[u]=a[u-1]),a},t.hermite=function(t,e,i){var n,s,o,a,h,c,u,l,g,d,p,f,m,y,x,b,v,w,D,C,R,M,S,I;if(t.length<2)throw"Invalid number of arguments to hermite";for(D={},function(t,e,i){return t*(1-i)+e*i},n=function(t){return function(t,e,i,n){return[t[0]+e[0]+i[0]+n[0],t[1]+e[1]+i[1]+n[1]]}}(),m=function(t){return function(t,e){return[t[0]*e[0],t[1]*e[1]]}}(),C=function(t){return function(t,e){return[t[0]-e[0],t[1]-e[1]]}}(),s=function(t,e,i){return Math.min(Math.max(t,e),i)},o=0,g=M=0,I=t.length-2;0<=I?M<=I:M>=I;g=0<=I?++M:--M)for(y=t[g],v=1/(b=(x=t[g+1])[0]-y[0]),g===t.length-2&&(v=1/(b-1)),p=m(C(x,g>0?t[g-1]:y),[.5,.5]),f=m(C(g<t.length-2?t[g+2]:x,y),[.5,.5]),d=S=0;0<=b?S<=b:S>=b;d=0<=b?++S:--S)c=(R=d*v)*R*R-2*R*R+R,u=-2*R*R*R+3*R*R,l=R*R*R-R*R,w=n(m(y,[h=2*R*R*R-3*R*R+1,h]),m(p,[c,c]),m(x,[u,u]),m(f,[l,l])),D[Math.round(w[0])]=Math.round(s(w[1],e,i)),o+=1;return a=t[t.length-1][0],D=r.Calculate.missingValues(D,a)},t.missingValues=function(t,e){var i,n,r,s,o,a,h;if(Object.keys(t).length<e+1){for(s={},i=a=0;0<=e?a<=e:a>=e;i=0<=e?++a:--a)if(null!=t[i])s[i]=t[i];else{for(r=[i-1,s[i-1]],n=h=i;i<=e?h<=e:h>=e;n=i<=e?++h:--h)if(null!=t[n]){o=[n,t[n]];break}s[i]=r[1]+(o[1]-r[1])/(o[0]-r[0])*(i-r[0])}return s}return t},t}(),n=r.Calculate,r.Convert=function(){function t(){}return t.hexToRGB=function(t){var e,i,n;return"#"===t.charAt(0)&&(t=t.substr(1)),n=parseInt(t.substr(0,2),16),i=parseInt(t.substr(2,2),16),e=parseInt(t.substr(4,2),16),{r:n,g:i,b:e}},t.rgbToHSL=function(t,e,i){var n,r,s,o,a,h;return"object"==typeof t&&(e=t.g,i=t.b,t=t.r),t/=255,e/=255,i/=255,o=Math.max(t,e,i),a=Math.min(t,e,i),s=(o+a)/2,o===a?r=h=0:(n=o-a,h=s>.5?n/(2-o-a):n/(o+a),r=function(){switch(o){case t:return(e-i)/n+(e<i?6:0);case e:return(i-t)/n+2;case i:return(t-e)/n+4}}(),r/=6),{h:r,s:h,l:s}},t.hslToRGB=function(t,e,i){var n,r,s,o,a;return"object"==typeof t&&(e=t.s,i=t.l,t=t.h),0===e?a=r=n=i:(s=2*i-(o=i<.5?i*(1+e):i+e-i*e),a=this.hueToRGB(s,o,t+1/3),r=this.hueToRGB(s,o,t),n=this.hueToRGB(s,o,t-1/3)),{r:255*a,g:255*r,b:255*n}},t.hueToRGB=function(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t},t.rgbToHSV=function(t,e,i){var n,r,s,o,a,h;return t/=255,e/=255,i/=255,s=Math.max(t,e,i),o=Math.min(t,e,i),h=s,n=s-o,a=0===s?0:n/s,s===o?r=0:(r=function(){switch(s){case t:return(e-i)/n+(e<i?6:0);case e:return(i-t)/n+2;case i:return(t-e)/n+4}}(),r/=6),{h:r,s:a,v:h}},t.hsvToRGB=function(t,e,i){var n,r,s,o,a,h,c,u;switch(o=Math.floor(6*t),r=6*t-o,a=i*(1-e),h=i*(1-r*e),u=i*(1-(1-r)*e),o%6){case 0:c=i,s=u,n=a;break;case 1:c=h,s=i,n=a;break;case 2:c=a,s=i,n=u;break;case 3:c=a,s=h,n=i;break;case 4:c=u,s=a,n=i;break;case 5:c=i,s=a,n=h}return{r:Math.floor(255*c),g:Math.floor(255*s),b:Math.floor(255*n)}},t.rgbToXYZ=function(t,e,i){var n,r,s;return t/=255,e/=255,i/=255,t>.04045?t=Math.pow((t+.055)/1.055,2.4):t/=12.92,e>.04045?e=Math.pow((e+.055)/1.055,2.4):e/=12.92,i>.04045?i=Math.pow((i+.055)/1.055,2.4):i/=12.92,n=.4124*t+.3576*e+.1805*i,r=.2126*t+.7152*e+.0722*i,s=.0193*t+.1192*e+.9505*i,{x:100*n,y:100*r,z:100*s}},t.xyzToRGB=function(t,e,i){var n,r,s;return t/=100,e/=100,i/=100,s=3.2406*t+-1.5372*e+-.4986*i,r=-.9689*t+1.8758*e+.0415*i,n=.0557*t+-.204*e+1.057*i,s>.0031308?s=1.055*Math.pow(s,.4166666667)-.055:s*=12.92,r>.0031308?r=1.055*Math.pow(r,.4166666667)-.055:r*=12.92,n>.0031308?n=1.055*Math.pow(n,.4166666667)-.055:n*=12.92,{r:255*s,g:255*r,b:255*n}},t.xyzToLab=function(t,e,i){var n,r,s;return"object"==typeof t&&(e=t.y,i=t.z,t=t.x),95.047,100,108.883,t/=95.047,e/=100,i/=108.883,t=t>.008856451679?Math.pow(t,.3333333333):7.787037037*t+.1379310345,e=e>.008856451679?Math.pow(e,.3333333333):7.787037037*e+.1379310345,i=i>.008856451679?Math.pow(i,.3333333333):7.787037037*i+.1379310345,s=116*e-16,n=500*(t-e),r=200*(e-i),{l:s,a:n,b:r}},t.labToXYZ=function(t,e,i){var n,r,s;return"object"==typeof t&&(e=t.a,i=t.b,t=t.l),r=(t+16)/116,n=r+e/500,s=r-i/200,n>.2068965517?n*=n*n:n=.1284185493*(n-.1379310345),r>.2068965517?r*=r*r:r=.1284185493*(r-.1379310345),s>.2068965517?s*=s*s:s=.1284185493*(s-.1379310345),{x:95.047*n,y:100*r,z:108.883*s}},t.rgbToLab=function(t,e,i){var n;return"object"==typeof t&&(e=t.g,i=t.b,t=t.r),n=this.rgbToXYZ(t,e,i),this.xyzToLab(n)},t.labToRGB=function(t,e,i){},t}(),a=r.Convert,r.Event=function(){function t(){}return t.events={},t.types=["processStart","processComplete","renderStart","renderFinished","blockStarted","blockFinished"],t.trigger=function(t,e,i){var n,r,s,o,a;if(null==i&&(i=null),this.events[e]&&this.events[e].length){for(a=[],r=0,s=(o=this.events[e]).length;r<s;r++)null===(n=o[r]).target||t.id===n.target.id?a.push(n.fn.call(t,i)):a.push(void 0);return a}},t.listen=function(t,e,i){var n,r;return"string"==typeof t&&(r=t,n=e,t=null,e=r,i=n),!(S.call(this.types,e)<0)&&(this.events[e]||(this.events[e]=[]),this.events[e].push({target:t,fn:i}),!0)},t}(),h=r.Event,r.Filter=function(){function t(){}return t.Type={Single:1,Kernel:2,LayerDequeue:3,LayerFinished:4,LoadOverlay:5,Plugin:6},t.register=function(t,e){return r.prototype[t]=e},t}(),u=r.Filter,r.IO=function(){function t(){}return t.domainRegex=/(?:(?:http|https):\/\/)((?:\w+)\.(?:(?:\w|\.)+))/,t.isRemote=function(t){return null!=t&&(!this.corsEnabled(t)&&this.isURLRemote(t.src))},t.corsEnabled=function(t){var e;return null!=t.crossOrigin&&("anonymous"===(e=t.crossOrigin.toLowerCase())||"use-credentials"===e)},t.isURLRemote=function(t){var e;return!!(e=t.match(this.domainRegex))&&e[1]!==document.domain},t.remoteCheck=function(t){if(this.isURLRemote(t)){if(r.remoteProxy.length)return r.isURLRemote(r.remoteProxy)?void p.info("Cannot use a remote proxy for loading images."):this.proxyUrl(t);p.info("Attempting to load a remote image without a configured proxy. URL: "+t)}},t.proxyUrl=function(t){return r.remoteProxy+"?"+r.proxyParam+"="+encodeURIComponent(t)},t.useProxy=function(t){var e;return e={ruby:"rb",python:"py",perl:"pl",javascript:"js"},t=t.toLowerCase(),null!=e[t]&&(t=e[t]),"proxies/caman_proxy."+t},t}(),r.prototype.save=function(){return"undefined"!=typeof exports&&null!==exports?this.nodeSave.apply(this,arguments):this.browserSave.apply(this,arguments)},r.prototype.browserSave=function(t){var e;return null==t&&(t="png"),t=t.toLowerCase(),e=this.toBase64(t).replace("image/"+t,"image/octet-stream"),document.location.href=e},r.prototype.nodeSave=function(t,e,i){null==e&&(e=!0),null==i&&(i=null);try{if(D.statSync(t).isFile()&&!e)return!1}catch(e){e,p.debug("Creating output file "+t)}return D.writeFile(t,this.canvas.toBuffer(),function(e){if(p.debug("Finished writing to "+t),i)return i.call(this,e)})},r.prototype.toImage=function(t){var e;return e=new g,e.src=this.toBase64(t),e.width=this.dimensions.width,e.height=this.dimensions.height,window.devicePixelRatio&&(e.width/=window.devicePixelRatio,e.height/=window.devicePixelRatio),e},r.prototype.toBase64=function(t){return null==t&&(t="png"),t=t.toLowerCase(),this.renderingCanvas.toDataURL("image/"+t)},l=r.IO,r.Layer=function(){function e(t){this.c=t,this.filter=this.c,this.options={blendingMode:"normal",opacity:1},this.layerID=w.uniqid.get(),this.canvas="undefined"!=typeof exports&&null!==exports?new o:document.createElement("canvas"),this.canvas.width=this.c.dimensions.width,this.canvas.height=this.c.dimensions.height,this.context=this.canvas.getContext("2d"),this.context.createImageData(this.canvas.width,this.canvas.height),this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),this.pixelData=this.imageData.data}return e.prototype.newLayer=function(t){return this.c.newLayer.call(this.c,t)},e.prototype.setBlendingMode=function(t){return this.options.blendingMode=t,this},e.prototype.opacity=function(t){return this.options.opacity=t/100,this},e.prototype.copyParent=function(){var t,e,i,n;for(e=this.c.pixelData,t=i=0,n=this.c.pixelData.length;i<n;t=i+=4)this.pixelData[t]=e[t],this.pixelData[t+1]=e[t+1],this.pixelData[t+2]=e[t+2],this.pixelData[t+3]=e[t+3];return this},e.prototype.fillColor=function(){return this.c.fillColor.apply(this.c,arguments)},e.prototype.overlayImage=function(e){return"object"==typeof e?e=e.src:"string"==typeof e&&"#"===e[0]&&(e=t(e).src),e?(this.c.renderer.renderQueue.push({type:u.Type.LoadOverlay,src:e,layer:this}),this):this},e.prototype.applyToParent=function(){var t,e,n,r,s,o,a,h,c;for(n=this.c.pixelStack[this.c.pixelStack.length-1],c=[],t=a=0,h=(e=this.c.pixelData).length;a<h;t=a+=4)o={r:n[t],g:n[t+1],b:n[t+2],a:n[t+3]},s={r:e[t],g:e[t+1],b:e[t+2],a:e[t+3]},(r=i.execute(this.options.blendingMode,s,o)).r=w.clampRGB(r.r),r.g=w.clampRGB(r.g),r.b=w.clampRGB(r.b),null==r.a&&(r.a=s.a),n[t]=o.r-(o.r-r.r)*(this.options.opacity*(r.a/255)),n[t+1]=o.g-(o.g-r.g)*(this.options.opacity*(r.a/255)),c.push(n[t+2]=o.b-(o.b-r.b)*(this.options.opacity*(r.a/255)));return c},e}(),d=r.Layer,r.Logger=function(){function t(){var t,e,i,n;for(e=0,i=(n=["log","info","warn","error"]).length;e<i;e++)this[t=n[e]]=function(t){return function(){var e;if(e=1<=arguments.length?I.call(arguments,0):[],r.DEBUG)try{return console[t].apply(console,e)}catch(i){return i,console[t](e)}}}(t);this.debug=this.log}return t}(),p=new r.Logger,r.Pixel=function(){function t(t,e,i,n,r){this.r=null!=t?t:0,this.g=null!=e?e:0,this.b=null!=i?i:0,this.a=null!=n?n:255,this.c=null!=r?r:null,this.loc=0}return t.coordinatesToLocation=function(t,e,i){return 4*(e*i+t)},t.locationToCoordinates=function(t,e){var i,n;return n=Math.floor(t/(4*e)),i=t%(4*e)/4,{x:i,y:n}},t.prototype.setContext=function(t){return this.c=t},t.prototype.locationXY=function(){var t,e;if(null==this.c)throw"Requires a CamanJS context";return e=this.c.dimensions.height-Math.floor(this.loc/(4*this.c.dimensions.width)),t=this.loc%(4*this.c.dimensions.width)/4,{x:t,y:e}},t.prototype.pixelAtLocation=function(e){if(null==this.c)throw"Requires a CamanJS context";return new t(this.c.pixelData[e],this.c.pixelData[e+1],this.c.pixelData[e+2],this.c.pixelData[e+3],this.c)},t.prototype.getPixelRelative=function(e,i){var n;if(null==this.c)throw"Requires a CamanJS context";return n=this.loc+4*this.c.dimensions.width*(-1*i)+4*e,n>this.c.pixelData.length||n<0?new t(0,0,0,255,this.c):this.pixelAtLocation(n)},t.prototype.putPixelRelative=function(t,e,i){if(null==this.c)throw"Requires a CamanJS context";if(this.loc+4*this.c.dimensions.width*(-1*e)+4*t,!(newLoc>this.c.pixelData.length||newLoc<0))return this.c.pixelData[newLoc]=i.r,this.c.pixelData[newLoc+1]=i.g,this.c.pixelData[newLoc+2]=i.b,this.c.pixelData[newLoc+3]=i.a,!0},t.prototype.getPixel=function(t,e){var i;if(null==this.c)throw"Requires a CamanJS context";return i=this.coordinatesToLocation(t,e,this.width),this.pixelAtLocation(i)},t.prototype.putPixel=function(t,e,i){var n;if(null==this.c)throw"Requires a CamanJS context";return n=this.coordinatesToLocation(t,e,this.width),this.c.pixelData[n]=i.r,this.c.pixelData[n+1]=i.g,this.c.pixelData[n+2]=i.b,this.c.pixelData[n+3]=i.a},t.prototype.toString=function(){return this.toKey()},t.prototype.toHex=function(t){var e;return null==t&&(t=!1),e="#"+this.r.toString(16)+this.g.toString(16)+this.b.toString(16),t?e+this.a.toString(16):e},t}(),m=r.Pixel,r.Plugin=function(){function t(){}return t.plugins={},t.register=function(t,e){return this.plugins[t]=e},t.execute=function(t,e,i){return this.plugins[e].apply(t,i)},t}(),y=r.Plugin,r.Renderer=function(){function t(t){this.c=t,this.processNext=B(this.processNext,this),this.renderQueue=[],this.modPixelData=null}return t.Blocks=r.NodeJS?require("os").cpus().length:4,t.prototype.add=function(t){if(null!=t)return this.renderQueue.push(t)},t.prototype.processNext=function(){var t;if(0===this.renderQueue.length)return h.trigger(this,"renderFinished"),null!=this.finishedFn&&this.finishedFn.call(this.c),this;switch(this.currentJob=this.renderQueue.shift(),this.currentJob.type){case u.Type.LayerDequeue:return t=this.c.canvasQueue.shift(),this.c.executeLayer(t),this.processNext();case u.Type.LayerFinished:return this.c.applyCurrentLayer(),this.c.popContext(),this.processNext();case u.Type.LoadOverlay:return this.loadOverlay(this.currentJob.layer,this.currentJob.src);case u.Type.Plugin:return this.executePlugin();default:return this.executeFilter()}},t.prototype.execute=function(t){return this.finishedFn=t,this.modPixelData=w.dataArray(this.c.pixelData.length),this.processNext()},t.prototype.eachBlock=function(e){var i,n,s,o,a,h,u,l,g,d;for(this.blocksDone=0,h=this.c.pixelData.length,a=(i=4*Math.floor(h/4/t.Blocks))+h/4%t.Blocks*4,d=[],o=l=0,g=t.Blocks;0<=g?l<g:l>g;o=0<=g?++l:--l)s=(u=o*i)+(o===t.Blocks-1?a:i),r.NodeJS?(n=c(function(t){return function(){return e.call(t,o,u,s)}}(this)).run(),d.push(this.blockFinished(n))):d.push(setTimeout(function(t){return function(i,n,r){return function(){return e.call(t,i,n,r)}}}(this)(o,u,s),0));return d},t.prototype.executeFilter=function(){return h.trigger(this.c,"processStart",this.currentJob),this.currentJob.type===u.Type.Single?this.eachBlock(this.renderBlock):this.eachBlock(this.renderKernel)},t.prototype.executePlugin=function(){return p.debug("Executing plugin "+this.currentJob.plugin),y.execute(this.c,this.currentJob.plugin,this.currentJob.args),p.debug("Plugin "+this.currentJob.plugin+" finished!"),this.processNext()},t.prototype.renderBlock=function(e,i,n){var s,o,a;for(p.debug("Block #"+e+" - Filter: "+this.currentJob.name+", Start: "+i+", End: "+n),h.trigger(this.c,"blockStarted",{blockNum:e,totalBlocks:t.Blocks,startPixel:i,endPixel:n}),(o=new m).setContext(this.c),s=a=i;a<n;s=a+=4)o.loc=s,o.r=this.c.pixelData[s],o.g=this.c.pixelData[s+1],o.b=this.c.pixelData[s+2],o.a=this.c.pixelData[s+3],this.currentJob.processFn(o),this.c.pixelData[s]=w.clampRGB(o.r),this.c.pixelData[s+1]=w.clampRGB(o.g),this.c.pixelData[s+2]=w.clampRGB(o.b),this.c.pixelData[s+3]=w.clampRGB(o.a);return r.NodeJS?c.yield(e):this.blockFinished(e)},t.prototype.renderKernel=function(t,e,i){var n,s,o,a,h,u,l,g,d,f,y,x,b,v,D,C,R;for(this.currentJob.name,o=this.currentJob.bias,u=this.currentJob.divisor,y=this.c.pixelData.length,n=this.currentJob.adjust,s=Math.sqrt(n.length),f=[],p.debug("Rendering kernel - Filter: "+this.currentJob.name),e=Math.max(e,4*this.c.dimensions.width*((s-1)/2)),i=Math.min(i,y-4*this.c.dimensions.width*((s-1)/2)),a=(s-1)/2,(b=new m).setContext(this.c),l=D=e;D<i;l=D+=4){for(b.loc=l,h=0,g=C=-a;-a<=a?C<=a:C>=a;g=-a<=a?++C:--C)for(d=R=a;a<=-a?R<=-a:R>=-a;d=a<=-a?++R:--R)x=b.getPixelRelative(g,d),f[3*h]=x.r,f[3*h+1]=x.g,f[3*h+2]=x.b,h++;v=this.processKernel(n,f,u,o),this.modPixelData[l]=w.clampRGB(v.r),this.modPixelData[l+1]=w.clampRGB(v.g),this.modPixelData[l+2]=w.clampRGB(v.b),this.modPixelData[l+3]=this.c.pixelData[l+3]}return r.NodeJS?c.yield(t):this.blockFinished(t)},t.prototype.blockFinished=function(e){var i,n,r;if(e>=0&&p.debug("Block #"+e+" finished! Filter: "+this.currentJob.name),this.blocksDone++,h.trigger(this.c,"blockFinished",{blockNum:e,blocksFinished:this.blocksDone,totalBlocks:t.Blocks}),this.blocksDone===t.Blocks){if(this.currentJob.type===u.Type.Kernel)for(i=n=0,r=this.c.pixelData.length;0<=r?n<r:n>r;i=0<=r?++n:--n)this.c.pixelData[i]=this.modPixelData[i];return e>=0&&p.debug("Filter "+this.currentJob.name+" finished!"),h.trigger(this.c,"processComplete",this.currentJob),this.processNext()}},t.prototype.processKernel=function(t,e,i,n){var r,s,o,a;for(s={r:0,g:0,b:0},r=o=0,a=t.length;0<=a?o<a:o>a;r=0<=a?++o:--o)s.r+=t[r]*e[3*r],s.g+=t[r]*e[3*r+1],s.b+=t[r]*e[3*r+2];return s.r=s.r/i+n,s.g=s.g/i+n,s.b=s.b/i+n,s},t.prototype.loadOverlay=function(t,e){var i,n;return i=new g,i.onload=function(e){return function(){return t.context.drawImage(i,0,0,e.c.dimensions.width,e.c.dimensions.height),t.imageData=t.context.getImageData(0,0,e.c.dimensions.width,e.c.dimensions.height),t.pixelData=t.imageData.data,e.c.pixelData=t.pixelData,e.processNext()}}(this),n=l.remoteCheck(e),i.src=null!=n?n:e},t}(),x=r.Renderer,r.Store=function(){function t(){}return t.items={},t.has=function(t){return null!=this.items[t]},t.get=function(t){return this.items[t]},t.put=function(t,e){return this.items[t]=e},t.execute=function(t,e){return setTimeout(function(i){return function(){return e.call(i.get(t),i.get(t))}}(this),0),this.get(t)},t.flush=function(t){return null==t&&(t=!1),t?delete this.items[t]:this.items={}},t}(),v=r.Store,i.register("normal",function(t,e){return{r:t.r,g:t.g,b:t.b}}),i.register("multiply",function(t,e){return{r:t.r*e.r/255,g:t.g*e.g/255,b:t.b*e.b/255}}),i.register("screen",function(t,e){return{r:255-(255-t.r)*(255-e.r)/255,g:255-(255-t.g)*(255-e.g)/255,b:255-(255-t.b)*(255-e.b)/255}}),i.register("overlay",function(t,e){var i;return i={},i.r=e.r>128?255-2*(255-t.r)*(255-e.r)/255:e.r*t.r*2/255,i.g=e.g>128?255-2*(255-t.g)*(255-e.g)/255:e.g*t.g*2/255,i.b=e.b>128?255-2*(255-t.b)*(255-e.b)/255:e.b*t.b*2/255,i}),i.register("difference",function(t,e){return{r:t.r-e.r,g:t.g-e.g,b:t.b-e.b}}),i.register("addition",function(t,e){return{r:e.r+t.r,g:e.g+t.g,b:e.b+t.b}}),i.register("exclusion",function(t,e){return{r:128-2*(e.r-128)*(t.r-128)/255,g:128-2*(e.g-128)*(t.g-128)/255,b:128-2*(e.b-128)*(t.b-128)/255}}),i.register("softLight",function(t,e){var i;return i={},i.r=e.r>128?255-(255-e.r)*(255-(t.r-128))/255:e.r*(t.r+128)/255,i.g=e.g>128?255-(255-e.g)*(255-(t.g-128))/255:e.g*(t.g+128)/255,i.b=e.b>128?255-(255-e.b)*(255-(t.b-128))/255:e.b*(t.b+128)/255,i}),i.register("lighten",function(t,e){return{r:e.r>t.r?e.r:t.r,g:e.g>t.g?e.g:t.g,b:e.b>t.b?e.b:t.b}}),i.register("darken",function(t,e){return{r:e.r>t.r?t.r:e.r,g:e.g>t.g?t.g:e.g,b:e.b>t.b?t.b:e.b}}),u.register("fillColor",function(){var t;return t=1===arguments.length?a.hexToRGB(arguments[0]):{r:arguments[0],g:arguments[1],b:arguments[2]},this.process("fillColor",function(e){return e.r=t.r,e.g=t.g,e.b=t.b,e.a=255,e})}),u.register("brightness",function(t){return t=Math.floor(t/100*255),this.process("brightness",function(e){return e.r+=t,e.g+=t,e.b+=t,e})}),u.register("saturation",function(t){return t*=-.01,this.process("saturation",function(e){var i;return i=Math.max(e.r,e.g,e.b),e.r!==i&&(e.r+=(i-e.r)*t),e.g!==i&&(e.g+=(i-e.g)*t),e.b!==i&&(e.b+=(i-e.b)*t),e})}),u.register("vibrance",function(t){return t*=-1,this.process("vibrance",function(e){var i,n,r;return r=Math.max(e.r,e.g,e.b),n=(e.r+e.g+e.b)/3,i=2*Math.abs(r-n)/255*t/100,e.r!==r&&(e.r+=(r-e.r)*i),e.g!==r&&(e.g+=(r-e.g)*i),e.b!==r&&(e.b+=(r-e.b)*i),e})}),u.register("greyscale",function(t){return this.process("greyscale",function(t){var e;return e=n.luminance(t),t.r=e,t.g=e,t.b=e,t})}),u.register("contrast",function(t){return t=Math.pow((t+100)/100,2),this.process("contrast",function(e){return e.r/=255,e.r-=.5,e.r*=t,e.r+=.5,e.r*=255,e.g/=255,e.g-=.5,e.g*=t,e.g+=.5,e.g*=255,e.b/=255,e.b-=.5,e.b*=t,e.b+=.5,e.b*=255,e})}),u.register("hue",function(t){return this.process("hue",function(e){var i,n,r,s,o,h;return s=a.rgbToHSV(e.r,e.g,e.b),r=100*s.h,r+=Math.abs(t),r%=100,r/=100,s.h=r,h=a.hsvToRGB(s.h,s.s,s.v),o=h.r,n=h.g,i=h.b,e.r=o,e.g=n,e.b=i,e})}),u.register("colorize",function(){var t,e;return 2===arguments.length?(e=a.hexToRGB(arguments[0]),t=arguments[1]):4===arguments.length&&(e={r:arguments[0],g:arguments[1],b:arguments[2]},t=arguments[3]),this.process("colorize",function(i){return i.r-=(i.r-e.r)*(t/100),i.g-=(i.g-e.g)*(t/100),i.b-=(i.b-e.b)*(t/100),i})}),u.register("invert",function(){return this.process("invert",function(t){return t.r=255-t.r,t.g=255-t.g,t.b=255-t.b,t})}),u.register("sepia",function(t){return null==t&&(t=100),t/=100,this.process("sepia",function(e){return e.r=Math.min(255,e.r*(1-.607*t)+e.g*(.769*t)+e.b*(.189*t)),e.g=Math.min(255,e.r*(.349*t)+e.g*(1-.314*t)+e.b*(.168*t)),e.b=Math.min(255,e.r*(.272*t)+e.g*(.534*t)+e.b*(1-.869*t)),e})}),u.register("gamma",function(t){return this.process("gamma",function(e){return e.r=255*Math.pow(e.r/255,t),e.g=255*Math.pow(e.g/255,t),e.b=255*Math.pow(e.b/255,t),e})}),u.register("noise",function(t){return t=2.55*Math.abs(t),this.process("noise",function(e){var i;return i=n.randomRange(-1*t,t),e.r+=i,e.g+=i,e.b+=i,e})}),u.register("clip",function(t){return t=2.55*Math.abs(t),this.process("clip",function(e){return e.r>255-t?e.r=255:e.r<t&&(e.r=0),e.g>255-t?e.g=255:e.g<t&&(e.g=0),e.b>255-t?e.b=255:e.b<t&&(e.b=0),e})}),u.register("channels",function(t){var e;if("object"!=typeof t)return this;for(e in t)P.call(t,e)&&(0!==t[e]?t[e]/=100:delete t[e]);return 0===t.length?this:this.process("channels",function(e){return null!=t.red&&(t.red>0?e.r+=(255-e.r)*t.red:e.r-=e.r*Math.abs(t.red)),null!=t.green&&(t.green>0?e.g+=(255-e.g)*t.green:e.g-=e.g*Math.abs(t.green)),null!=t.blue&&(t.blue>0?e.b+=(255-e.b)*t.blue:e.b-=e.b*Math.abs(t.blue)),e})}),u.register("curves",function(){var t,e,i,r,s,o,a,h,c,u,l,g;if(i=arguments[0],r=2<=arguments.length?I.call(arguments,1):[],a=r[r.length-1],"function"==typeof a?(t=a,r.pop()):"string"==typeof a?(t=n[a],r.pop()):t=n.bezier,"string"==typeof i&&(i=i.split("")),"v"===i[0]&&(i=["r","g","b"]),r.length<2)throw"Invalid number of arguments to curves filter";if(e=t(r,0,255),(h=r[0])[0]>0)for(o=c=0,l=h[0];0<=l?c<l:c>l;o=0<=l?++c:--c)e[o]=h[1];if((s=r[r.length-1])[0]<255)for(o=u=g=s[0];g<=255?u<=255:u>=255;o=g<=255?++u:--u)e[o]=s[1];return this.process("curves",function(t){var n,r;for(o=n=0,r=i.length;0<=r?n<r:n>r;o=0<=r?++n:--n)t[i[o]]=e[t[i[o]]];return t})}),u.register("exposure",function(t){var e,i,n;return n=Math.abs(t)/100,e=[0,255*n],i=[255-255*n,255],t<0&&(e=e.reverse(),i=i.reverse()),this.curves("rgb",[0,0],e,i,[255,255])}),r.Plugin.register("crop",function(t,e,i,n){var r;return null==i&&(i=0),null==n&&(n=0),"undefined"!=typeof exports&&null!==exports?r=new o(t,e):(r=document.createElement("canvas"),w.copyAttributes(this.canvas,r),r.width=t,r.height=e),r.getContext("2d").drawImage(this.canvas,i,n,t,e,0,0,t,e),this.cropCoordinates={x:i,y:n},this.cropped=!0,this.replaceCanvas(r)}),r.Plugin.register("resize",function(t){var e;null==t&&(t=null);{if(null!==t&&(null!=t.width||null!=t.height))return null==t.width?t.width=this.canvas.width*t.height/this.canvas.height:null==t.height&&(t.height=this.canvas.height*t.width/this.canvas.width),"undefined"!=typeof exports&&null!==exports?e=new o(t.width,t.height):(e=document.createElement("canvas"),w.copyAttributes(this.canvas,e),e.width=t.width,e.height=t.height),e.getContext("2d").drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,t.width,t.height),this.resized=!0,this.replaceCanvas(e);p.error("Invalid or missing dimensions given for resize")}}),r.Filter.register("crop",function(){return this.processPlugin("crop",Array.prototype.slice.call(arguments,0))}),r.Filter.register("resize",function(){return this.processPlugin("resize",Array.prototype.slice.call(arguments,0))}),r.Filter.register("boxBlur",function(){return this.processKernel("Box Blur",[1,1,1,1,1,1,1,1,1])}),r.Filter.register("heavyRadialBlur",function(){return this.processKernel("Heavy Radial Blur",[0,0,1,0,0,0,1,1,1,0,1,1,1,1,1,0,1,1,1,0,0,0,1,0,0])}),r.Filter.register("gaussianBlur",function(){return this.processKernel("Gaussian Blur",[1,4,6,4,1,4,16,24,16,4,6,24,36,24,6,4,16,24,16,4,1,4,6,4,1])}),r.Filter.register("motionBlur",function(t){var e;return e=0===t||180===t?[0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0]:t>0&&t<90||t>180&&t<270?[0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0]:90===t||270===t?[0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0]:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1],this.processKernel("Motion Blur",e)}),r.Filter.register("sharpen",function(t){return null==t&&(t=100),t/=100,this.processKernel("Sharpen",[0,-t,0,-t,4*t+1,-t,0,-t,0])}),M={brightness:function(t,e,i){return t.r=t.r-t.r*e*i.strength,t.g=t.g-t.g*e*i.strength,t.b=t.b-t.b*e*i.strength,t},gamma:function(t,e,i){return t.r=255*Math.pow(t.r/255,Math.max(10*e*i.strength,1)),t.g=255*Math.pow(t.g/255,Math.max(10*e*i.strength,1)),t.b=255*Math.pow(t.b/255,Math.max(10*e*i.strength,1)),t},colorize:function(t,e,i){return t.r-=(t.r-i.color.r)*e,t.g-=(t.g-i.color.g)*e,t.b-=(t.b-i.color.b)*e,t}},u.register("vignette",function(t,e){var i,r,s,o;return null==e&&(e=60),"string"==typeof t&&"%"===t.substr(-1)&&(t=this.dimensions.height>this.dimensions.width?this.dimensions.width*(parseInt(t.substr(0,t.length-1),10)/100):this.dimensions.height*(parseInt(t.substr(0,t.length-1),10)/100)),e/=100,r=[this.dimensions.width/2,this.dimensions.height/2],o=Math.sqrt(Math.pow(r[0],2)+Math.pow(r[1],2)),s=o-t,i=n.bezier([0,1],[30,30],[70,60],[100,80]),this.process("vignette",function(o){var a,h,c;return c=o.locationXY(),(a=n.distance(c.x,c.y,r[0],r[1]))>s&&(h=Math.max(1,i[Math.round((a-s)/t*100)]/10*e),o.r=255*Math.pow(o.r/255,h),o.g=255*Math.pow(o.g/255,h),o.b=255*Math.pow(o.b/255,h)),o})}),u.register("rectangularVignette",function(t){var e,i,s,o,h,c,u;if(e={strength:50,cornerRadius:0,method:"brightness",color:{r:0,g:0,b:0}},!(t=w.extend(e,t)).size)return this;if("string"==typeof t.size)s=parseInt(t.size,10)/100,t.size={width:this.dimensions.width*s,height:this.dimensions.height*s};else if("object"==typeof t.size)for(h=0,c=(u=["width","height"]).length;h<c;h++)i=u[h],"string"==typeof t.size[i]&&(t.size[i]=this.dimensions[i]*(parseInt(t.size[i],10)/100));else"number"===t.size&&(o=t.size,t.size={width:o,height:o});return"string"==typeof t.cornerRadius&&(t.cornerRadius=t.size.width/2*(parseInt(t.cornerRadius,10)/100)),t.strength/=100,t.size.width=Math.floor(t.size.width),t.size.height=Math.floor(t.size.height),t.image={width:this.dimensions.width,height:this.dimensions.height},"colorize"===t.method&&"string"==typeof t.color&&(t.color=a.hexToRGB(t.color)),t.coords={left:(this.dimensions.width-t.size.width)/2,right:this.dimensions.width-t.coords.left,bottom:(this.dimensions.height-t.size.height)/2,top:this.dimensions.height-t.coords.bottom},t.corners=[{x:t.coords.left+t.cornerRadius,y:t.coords.top-t.cornerRadius},{x:t.coords.right-t.cornerRadius,y:t.coords.top-t.cornerRadius},{x:t.coords.right-t.cornerRadius,y:t.coords.bottom+t.cornerRadius},{x:t.coords.left+t.cornerRadius,y:t.coords.bottom+t.cornerRadius}],t.maxDist=n.distance(0,0,t.corners[3].x,t.corners[3].y)-t.cornerRadius,this.process("rectangularVignette",function(e){var i,n;return(n=e.locationXY()).x>t.corners[0].x&&n.x<t.corners[1].x&&n.y>t.coords.bottom&&n.y<t.coords.top?e:n.x>t.coords.left&&n.x<t.coords.right&&n.y>t.corners[3].y&&n.y<t.corners[2].y?e:(n.x>t.corners[0].x&&n.x<t.corners[1].x&&n.y>t.coords.top?i=(n.y-t.coords.top)/t.maxDist:n.y>t.corners[2].y&&n.y<t.corners[1].y&&n.x>t.coords.right?i=(n.x-t.coords.right)/t.maxDist:n.x>t.corners[0].x&&n.x<t.corners[1].x&&n.y<t.coords.bottom?i=(t.coords.bottom-n.y)/t.maxDist:n.y>t.corners[2].y&&n.y<t.corners[1].y&&n.x<t.coords.left?i=(t.coords.left-n.x)/t.maxDist:n.x<=t.corners[0].x&&n.y>=t.corners[0].y?i=(r.distance(n.x,n.y,t.corners[0].x,t.corners[0].y)-t.cornerRadius)/t.maxDist:n.x>=t.corners[1].x&&n.y>=t.corners[1].y?i=(r.distance(n.x,n.y,t.corners[1].x,t.corners[1].y)-t.cornerRadius)/t.maxDist:n.x>=t.corners[2].x&&n.y<=t.corners[2].y?i=(r.distance(n.x,n.y,t.corners[2].x,t.corners[2].y)-t.cornerRadius)/t.maxDist:n.x<=t.corners[3].x&&n.y<=t.corners[3].y&&(i=(r.distance(n.x,n.y,t.corners[3].x,t.corners[3].y)-t.cornerRadius)/t.maxDist),i<0?e:M[t.method](e,i,t))})}),function(){var t,e,i,n,s;n=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],s=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],e=function(t,e,i,n,r,s,a){var h,c,u,l,g,d,p;return h="undefined"!=typeof exports&&null!==exports?new o:document.createElement("canvas"),h.width=t,h.height=e,l=i+Math.cos(r)*s*.5,d=n+Math.sin(r)*s*.5,g=i-Math.cos(r)*s*.5,p=n-Math.sin(r)*s*.5,c=h.getContext("2d"),u=c.createLinearGradient(l,d,g,p),a?(u.addColorStop(0,"white"),u.addColorStop(.5,"black"),u.addColorStop(1,"white")):(u.addColorStop(0,"white"),u.addColorStop(1,"black")),c.fillStyle=u,c.fillRect(0,0,t,e),c.getImageData(0,0,t,e)},i=function(t,e,i,n,r,s){var a,h,c;return a="undefined"!=typeof exports&&null!==exports?new o:document.createElement("canvas"),a.width=t,a.height=e,h=a.getContext("2d"),(c=h.createRadialGradient(i,n,r,i,n,s)).addColorStop(1,"white"),c.addColorStop(0,"black"),h.fillStyle=c,h.fillRect(0,0,t,e),h.getImageData(0,0,t,e)},t=function(){return this.r=0,this.g=0,this.b=0,this.a=0,this.next=null},r.Plugin.register("compoundBlur",function(e,i,r,o){var a,h,c,u,l,g,d,p,f,m,y,x,b,v,w,D,C,R,M,S,I,P,B,F,L,k,T,z,A,O,E,H,j,J,N,W,G,U,q,V,K,X,Y,Q,$,_,Z,tt,et,it,nt,rt,st,ot,at,ht,ct;for(K=this.dimensions.width,m=this.dimensions.height,w=this.pixelData,z=e.data,V=(q=K*m)<<2,B=[],x=tt=0;0<=V?tt<V:tt>V;x=0<=V?++tt:--tt)B[x]=w[x];for(l=0,G=o,o-=1;G-- >=0;)if(0!==(C=i+.5|0)){for(C>256&&(C=256),g=C+C+1,K<<2,X=K-1,y=m-1,U=(A=C+1)*(A+1)/2,j=void 0,H=W=new t,x=et=1;1<=g?et<g:et>g;x=1<=g?++et:--et)H=H.next=new t,x===A&&(j=H);for(H.next=W,J=null,N=null,Z=$=0,M=n[C],E=s[C],Q=it=0;0<=m?it<m:it>m;Q=0<=m?++it:--it){for(L=d=a=T=f=c=0,k=A*(F=B[$]),p=A*(P=B[$+1]),h=A*(I=B[$+2]),T+=U*F,f+=U*P,c+=U*I,H=W,x=nt=0;0<=A?nt<A:nt>A;x=0<=A?++nt:--nt)H.r=F,H.g=P,H.b=I,H=H.next;for(x=rt=1;1<=A?rt<A:rt>A;x=1<=A?++rt:--rt)S=$+((X<x?X:x)<<2),T+=(H.r=F=B[S])*(O=A-x),f+=(H.g=P=B[S+1])*O,c+=(H.b=I=B[S+2])*O,L+=F,d+=P,a+=I,H=H.next;for(J=W,N=j,Y=st=0;0<=K?st<K:st>K;Y=0<=K?++st:--st)B[$]=T*M>>E,B[$+1]=f*M>>E,B[$+2]=c*M>>E,T-=k,f-=p,c-=h,k-=J.r,p-=J.g,h-=J.b,S=Z+((S=Y+A)<X?S:X)<<2,T+=L+=J.r=B[S],f+=d+=J.g=B[S+1],c+=a+=J.b=B[S+2],J=J.next,k+=F=N.r,p+=P=N.g,h+=I=N.b,L-=F,d-=P,a-=I,N=N.next,$+=4;Z+=K}for(Y=ot=0;0<=K?ot<K:ot>K;Y=0<=K?++ot:--ot){for(d=a=L=f=c=T=0,k=A*(F=B[$=Y<<2]),p=A*(P=B[$+1]),h=A*(I=B[$+2]),T+=U*F,f+=U*P,c+=U*I,H=W,x=at=0;0<=A?at<A:at>A;x=0<=A?++at:--at)H.r=F,H.g=P,H.b=I,H=H.next;for(_=K,x=ht=1;1<=A?ht<A:ht>A;x=1<=A?++ht:--ht)$=_+Y<<2,T+=(H.r=F=B[$])*(O=A-x),f+=(H.g=P=B[$+1])*O,c+=(H.b=I=B[$+2])*O,L+=F,d+=P,a+=I,H=H.next,x<y&&(_+=K);for($=Y,J=W,N=j,Q=ct=0;0<=m?ct<m:ct>m;Q=0<=m?++ct:--ct)B[S=$<<2]=T*M>>E,B[S+1]=f*M>>E,B[S+2]=c*M>>E,T-=k,f-=p,c-=h,k-=J.r,p-=J.g,h-=J.b,S=Y+((S=Q+A)<y?S:y)*K<<2,T+=L+=J.r=B[S],f+=d+=J.g=B[S+1],c+=a+=J.b=B[S+2],J=J.next,k+=F=N.r,p+=P=N.g,h+=I=N.b,L-=F,d-=P,a-=I,N=N.next,$+=K}for(i*=r,x=q;--x>-1;)(D=0|(R=(255&z[(v=x<<2)+2])/255*o))===l?(b=256-(u=256*(R-(0|R))),w[v]=w[v]*b+B[v]*u>>8,w[v+1]=w[v+1]*b+B[v+1]*u>>8,w[v+2]=w[v+2]*b+B[v+2]*u>>8):D===l+1&&(w[v]=B[v],w[v+1]=B[v+1],w[v+2]=B[v+2]);l++}return this}),r.Filter.register("tiltShift",function(t){var i,n;return i={center:{x:this.dimensions.width/2,y:this.dimensions.height/2},angle:45,focusWidth:200,startRadius:3,radiusFactor:1.5,steps:3},t=w.extend(i,t),t.angle*=Math.PI/180,n=e(this.dimensions.width,this.dimensions.height,t.center.x,t.center.y,t.angle,t.focusWidth,!0),this.processPlugin("compoundBlur",[n,t.startRadius,t.radiusFactor,t.steps])}),r.Filter.register("radialBlur",function(t){var e,n,r,s;return e={size:50,center:{x:this.dimensions.width/2,y:this.dimensions.height/2},startRadius:3,radiusFactor:1.5,steps:3,radius:null},(t=w.extend(e,t)).radius||(t.radius=this.dimensions.width<this.dimensions.height?this.dimensions.height:this.dimensions.width),r=t.radius/2-t.size,s=t.radius/2,n=i(this.dimensions.width,this.dimensions.height,t.center.x,t.center.y,r,s),this.processPlugin("compoundBlur",[n,t.startRadius,t.radiusFactor,t.steps])})}(),r.Filter.register("edgeEnhance",function(){return this.processKernel("Edge Enhance",[0,0,0,-1,1,0,0,0,0])}),r.Filter.register("edgeDetect",function(){return this.processKernel("Edge Detect",[-1,-1,-1,-1,8,-1,-1,-1,-1])}),r.Filter.register("emboss",function(){return this.processKernel("Emboss",[-2,-1,0,-1,1,1,0,1,2])}),r.Filter.register("posterize",function(t){var e,i;return e=256/t,i=255/(t-1),this.process("posterize",function(t){return t.r=Math.floor(Math.floor(t.r/e)*i),t.g=Math.floor(Math.floor(t.g/e)*i),t.b=Math.floor(Math.floor(t.b/e)*i),t})}),r.Filter.register("vintage",function(t){if(null==t&&(t=!0),this.greyscale(),this.contrast(5),this.noise(3),this.sepia(100),this.channels({red:8,blue:2,green:4}),this.gamma(.87),t)return this.vignette("40%",30)}),r.Filter.register("lomo",function(t){return null==t&&(t=!0),this.brightness(15),this.exposure(15),this.curves("rgb",[0,0],[200,0],[155,255],[255,255]),this.saturation(-20),this.gamma(1.8),t&&this.vignette("50%",60),this.brightness(5)}),r.Filter.register("clarity",function(t){return null==t&&(t=!1),this.vibrance(20),this.curves("rgb",[5,0],[130,150],[190,220],[250,255]),this.sharpen(15),this.vignette("45%",20),t&&(this.greyscale(),this.contrast(4)),this}),r.Filter.register("sinCity",function(){return this.contrast(100),this.brightness(15),this.exposure(10),this.posterize(80),this.clip(30),this.greyscale()}),r.Filter.register("sunrise",function(){return this.exposure(3.5),this.saturation(-5),this.vibrance(50),this.sepia(60),this.colorize("#e87b22",10),this.channels({red:8,blue:8}),this.contrast(5),this.gamma(1.2),this.vignette("55%",25)}),r.Filter.register("crossProcess",function(){return this.exposure(5),this.colorize("#e87b22",4),this.sepia(20),this.channels({blue:8,red:3}),this.curves("b",[0,0],[100,150],[180,180],[255,255]),this.contrast(15),this.vibrance(75),this.gamma(1.6)}),r.Filter.register("orangePeel",function(){return this.curves("rgb",[0,0],[100,50],[140,200],[255,255]),this.vibrance(-30),this.saturation(-30),this.colorize("#ff9000",30),this.contrast(-5),this.gamma(1.4)}),r.Filter.register("love",function(){return this.brightness(5),this.exposure(8),this.contrast(4),this.colorize("#c42007",30),this.vibrance(50),this.gamma(1.3)}),r.Filter.register("grungy",function(){return this.gamma(1.5),this.clip(25),this.saturation(-60),this.contrast(5),this.noise(5),this.vignette("50%",30)}),r.Filter.register("jarques",function(){return this.saturation(-35),this.curves("b",[20,0],[90,120],[186,144],[255,230]),this.curves("r",[0,0],[144,90],[138,120],[255,255]),this.curves("g",[10,0],[115,105],[148,100],[255,248]),this.curves("rgb",[0,0],[120,100],[128,140],[255,255]),this.sharpen(20)}),r.Filter.register("pinhole",function(){return this.greyscale(),this.sepia(10),this.exposure(10),this.contrast(15),this.vignette("60%",35)}),r.Filter.register("oldBoot",function(){return this.saturation(-20),this.vibrance(-50),this.gamma(1.1),this.sepia(30),this.channels({red:-10,blue:5}),this.curves("rgb",[0,0],[80,50],[128,230],[255,255]),this.vignette("60%",30)}),r.Filter.register("glowingSun",function(t){if(null==t&&(t=!0),this.brightness(10),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(80),this.copyParent(),this.filter.gamma(.8),this.filter.contrast(50),this.filter.exposure(10)}),this.newLayer(function(){return this.setBlendingMode("softLight"),this.opacity(80),this.fillColor("#f49600")}),this.exposure(20),this.gamma(.8),t)return this.vignette("45%",20)}),r.Filter.register("hazyDays",function(){return this.gamma(1.2),this.newLayer(function(){return this.setBlendingMode("overlay"),this.opacity(60),this.copyParent(),this.filter.channels({red:5}),this.filter.stackBlur(15)}),this.newLayer(function(){return this.setBlendingMode("addition"),this.opacity(40),this.fillColor("#6899ba")}),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(35),this.copyParent(),this.filter.brightness(40),this.filter.vibrance(40),this.filter.exposure(30),this.filter.contrast(15),this.filter.curves("r",[0,40],[128,128],[128,128],[255,215]),this.filter.curves("g",[0,40],[128,128],[128,128],[255,215]),this.filter.curves("b",[0,40],[128,128],[128,128],[255,215]),this.filter.stackBlur(5)}),this.curves("r",[20,0],[128,158],[128,128],[235,255]),this.curves("g",[20,0],[128,128],[128,128],[235,255]),this.curves("b",[20,0],[128,108],[128,128],[235,255]),this.vignette("45%",20)}),r.Filter.register("herMajesty",function(){return this.brightness(40),this.colorize("#ea1c5d",10),this.curves("b",[0,10],[128,180],[190,190],[255,255]),this.newLayer(function(){return this.setBlendingMode("overlay"),this.opacity(50),this.copyParent(),this.filter.gamma(.7),this.newLayer(function(){return this.setBlendingMode("normal"),this.opacity(60),this.fillColor("#ea1c5d")})}),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(60),this.copyParent(),this.filter.saturation(50),this.filter.hue(90),this.filter.contrast(10)}),this.gamma(1.4),this.vibrance(-30),this.newLayer(function(){return this.opacity(10),this.fillColor("#e5f0ff")}),this}),r.Filter.register("nostalgia",function(){return this.saturation(20),this.gamma(1.4),this.greyscale(),this.contrast(5),this.sepia(100),this.channels({red:8,blue:2,green:4}),this.gamma(.8),this.contrast(5),this.exposure(10),this.newLayer(function(){return this.setBlendingMode("overlay"),this.copyParent(),this.opacity(55),this.filter.stackBlur(10)}),this.vignette("50%",30)}),r.Filter.register("hemingway",function(){return this.greyscale(),this.contrast(10),this.gamma(.9),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(40),this.copyParent(),this.filter.exposure(15),this.filter.contrast(15),this.filter.channels({green:10,red:5})}),this.sepia(30),this.curves("rgb",[0,10],[120,90],[180,200],[235,255]),this.channels({red:5,green:-2}),this.exposure(15)}),r.Filter.register("concentrate",function(){return this.sharpen(40),this.saturation(-50),this.channels({red:3}),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(80),this.copyParent(),this.filter.sharpen(5),this.filter.contrast(50),this.filter.exposure(10),this.filter.channels({blue:5})}),this.brightness(10)}),r.Plugin.register("rotate",function(t){var e,i,n,r,s,a,h,c;return 0===(e=t%360)?this.dimensions={width:this.canvas.width,height:this.canvas.height}:(s=Math.PI/180,"undefined"!=typeof exports&&null!==exports?i=new o:(i=document.createElement("canvas"),w.copyAttributes(this.canvas,i)),90===e||-270===e||270===e||-90===e?(h=(a=this.canvas.height)/2,c=(r=this.canvas.width)/2):180===e?(h=(a=this.canvas.width)/2,c=(r=this.canvas.height)/2):(r=a=Math.sqrt(Math.pow(this.originalWidth,2)+Math.pow(this.originalHeight,2)),h=this.canvas.height/2,c=this.canvas.width/2),i.width=a,i.height=r,(n=i.getContext("2d")).save(),n.translate(h,c),n.rotate(e*s),n.drawImage(this.canvas,-this.canvas.width/2,-this.canvas.height/2,this.canvas.width,this.canvas.height),n.restore(),this.rotationAngle+=t,this.rotated=!0,this.replaceCanvas(i))}),r.Filter.register("rotate",function(){return this.processPlugin("rotate",Array.prototype.slice.call(arguments,0))}),function(){var t,e,i;e=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],i=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],t=function(){return this.r=0,this.g=0,this.b=0,this.a=0,this.next=null},r.Plugin.register("stackBlur",function(n){var r,s,o,a,h,c,u,l,g,d,p,f,m,y,x,b,v,w,D,C,R,M,S,I,P,B,F,L,k,T,z,A,O,E,H,j,J,N,W,G,U,q,V,K;if(!(isNaN(n)||n<1)){for(n|=0,x=this.pixelData,a=n+n+1,(k=this.dimensions.width)<<2,T=k-1,g=(l=this.dimensions.height)-1,L=(C=n+1)*(C+1)/2,S=F=new t,d=j=1;1<=a?j<a:j>a;d=1<=a?++j:--j)S=S.next=new t,d===C&&(I=S);for(S.next=F,P=null,B=null,H=O=0,p=e[n],M=i[n],A=J=0;0<=l?J<l:J>l;A=0<=l?++J:--J){for(v=h=r=D=u=o=0,w=C*(b=x[O]),c=C*(y=x[O+1]),s=C*(m=x[O+2]),D+=L*b,u+=L*y,o+=L*m,S=F,d=N=0;0<=C?N<C:N>C;d=0<=C?++N:--N)S.r=b,S.g=y,S.b=m,S=S.next;for(d=W=1;1<=C?W<C:W>C;d=1<=C?++W:--W)f=O+((T<d?T:d)<<2),D+=(S.r=b=x[f])*(R=C-d),u+=(S.g=y=x[f+1])*R,o+=(S.b=m=x[f+2])*R,v+=b,h+=y,r+=m,S=S.next;for(P=F,B=I,z=G=0;0<=k?G<k:G>k;z=0<=k?++G:--G)x[O]=D*p>>M,x[O+1]=u*p>>M,x[O+2]=o*p>>M,D-=w,u-=c,o-=s,w-=P.r,c-=P.g,s-=P.b,f=H+((f=z+n+1)<T?f:T)<<2,D+=v+=P.r=x[f],u+=h+=P.g=x[f+1],o+=r+=P.b=x[f+2],P=P.next,w+=b=B.r,c+=y=B.g,s+=m=B.b,v-=b,h-=y,r-=m,B=B.next,O+=4;H+=k}for(z=U=0;0<=k?U<k:U>k;z=0<=k?++U:--U){for(h=r=v=u=o=D=0,w=C*(b=x[O=z<<2]),c=C*(y=x[O+1]),s=C*(m=x[O+2]),D+=L*b,u+=L*y,o+=L*m,S=F,d=q=0;0<=C?q<C:q>C;d=0<=C?++q:--q)S.r=b,S.g=y,S.b=m,S=S.next;for(E=k,d=V=1;1<=n?V<=n:V>=n;d=1<=n?++V:--V)O=E+z<<2,D+=(S.r=b=x[O])*(R=C-d),u+=(S.g=y=x[O+1])*R,o+=(S.b=m=x[O+2])*R,v+=b,h+=y,r+=m,S=S.next,d<g&&(E+=k);for(O=z,P=F,B=I,A=K=0;0<=l?K<l:K>l;A=0<=l?++K:--K)x[f=O<<2]=D*p>>M,x[f+1]=u*p>>M,x[f+2]=o*p>>M,D-=w,u-=c,o-=s,w-=P.r,c-=P.g,s-=P.b,f=z+((f=A+C)<g?f:g)*k<<2,D+=v+=P.r=x[f],u+=h+=P.g=x[f+1],o+=r+=P.b=x[f+2],P=P.next,w+=b=B.r,c+=y=B.g,s+=m=B.b,v-=b,h-=y,r-=m,B=B.next,O+=k}return this}}),r.Filter.register("stackBlur",function(t){return this.processPlugin("stackBlur",[t])})}(),r.Filter.register("threshold",function(t){return this.process("threshold",function(e){var i;return i=.2126*e.r+.7152*e.g+.0722*e.b,i<t?(e.r=0,e.g=0,e.b=0):(e.r=255,e.g=255,e.b=255),e})})}).call(this),angular.module("ringid.shared").controller("ringPhotoEditorController",ringPhotoEditorController),ringPhotoEditorController.$inject=["$scope","$ringbox"];